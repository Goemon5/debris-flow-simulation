# OpenFOAM 2段階シミュレーション - 匂い拡散計算専門技術解説

## 概要

本文書は、OpenFOAMにおけるsimpleFoam→scalarTransportFoamの2段階ワークフローにおいて、ステップ2（匂い拡散計算）の設定ファイル修正について、CFD工学的観点から詳細に解説します。

## 1. 設定ファイル修正の理論的背景

### 1.1 2段階計算の数学的基礎

**ステップ1（simpleFoam）**: Navier-Stokes方程式の定常解
```
∇·U = 0                    (連続の式)
∇·(UU) = -∇p/ρ + ∇·τ      (運動量方程式)
```

**ステップ2（scalarTransportFoam）**: 固定流れ場でのスカラー輸送
```
∂C/∂t + ∇·(UC) = ∇·(D∇C) + S    (スカラー輸送方程式)
```

ここで、Uは固定された速度場、Cは濃度、Dは拡散係数、Sは源項。

### 1.2 流れ場固定化の工学的意義

1. **計算効率**: 流れ場の再計算を回避し、スカラー輸送のみに集中
2. **数値安定性**: 流れ場の変動によるスカラー場の非物理的振動を防止
3. **物理的妥当性**: 準定常近似（匂い拡散の時間スケール >> 流れの時間スケール）

## 2. controlDict修正の詳細解説

### 2.1 アプリケーション変更
```cpp
application     scalarTransportFoam;  // simpleFoam から変更
```

**理由**: scalarTransportFoamは事前に計算された速度場phiを読み込み、スカラー輸送方程式のみを解く専用ソルバー。

### 2.2 時間設定の過渡化
```cpp
startFrom       startTime;
startTime       0;              // 匂い拡散の時間原点
endTime         5;              // 5秒間の拡散過程
deltaT          0.01;           // Courant数制約を満たす時間刻み
```

**Courant数の考慮**:
```
Co = |U|·Δt/Δx < 1
```
瓦礫周りの高速流域（|U|≈2m/s）とメッシュサイズ（Δx≈0.02m）から：
```
Δt < 0.02/(2×1) = 0.01s
```

### 2.3 出力制御
```cpp
writeInterval   50;             // 0.5秒間隔（50×0.01s）
```

**理由**: 匂い拡散の特性時間（τ ≈ L²/D ≈ (1m)²/(1e-5 m²/s) ≈ 10⁵s）に比べて十分細かい時間解像度。

## 3. fvSchemes修正の数値解法論

### 3.1 時間微分スキーム
```cpp
ddtSchemes
{
    default         Euler;          // 1次精度陽的オイラー法
}
```

**選択理由**:
- **安定性**: 拡散支配的問題では条件付き安定
- **精度**: 匂い拡散の緩やかな時間変化に対して十分
- **効率**: 計算負荷が軽い

**代替案**:
- `backward`: 2次精度陰的スキーム（より安定、計算負荷大）
- `CrankNicolson 0.5`: 2次精度半陰的スキーム

### 3.2 対流項の数値拡散制御
```cpp
div(phi,C)      bounded Gauss linearUpwind grad(C);
```

**技術的分析**:
- **linearUpwind**: 風上差分の数値拡散を抑制
- **bounded**: Total Variation Diminishing (TVD)特性で非物理的振動防止
- **grad(C)**: 局所勾配情報を活用した高精度化

**他のスキームとの比較**:
- `upwind`: 1次精度、安定だが数値拡散大
- `linear`: 2次精度だが振動しやすい
- `QUICK`: 3次精度だが境界処理が複雑

### 3.3 拡散項の処理
```cpp
laplacian(D,C)  Gauss linear corrected;
```

**corrected**の意義:
- 非直交格子での拡散項の精度改善
- ∇²C の離散化誤差を non-orthogonal correction で補正

## 4. fvSolution修正の反復解法理論

### 4.1 流れ場ソルバーの完全削除
```cpp
// 削除された設定:
// U, p, k, epsilon, nut のソルバー
```

**CFD工学的重要性**:
1. **メモリ効率**: 不要な行列演算の排除
2. **計算安定性**: 流れ場の数値的変動によるカップリング不安定回避
3. **物理的整合性**: 一方向カップリング（flow → scalar）の明確化

### 4.2 濃度場専用ソルバー
```cpp
C
{
    solver          PBiCGStab;      // 前処理付き双共役勾配法
    preconditioner  DILU;           // 対角不完全LU分解
    tolerance       1e-08;          // 高精度収束判定
}
```

**PBiCGStab選択の数値解析的根拠**:
- **非対称行列**: 対流項により係数行列が非対称
- **収束性**: BiCGStabは非対称系で高い収束性
- **前処理**: DILUにより条件数改善

**代替ソルバーとの性能比較**:
- `GAMG`: 幾何学的多重格子、大規模系で効率的
- `PCG`: 対称系専用、拡散支配で使用可能
- `smoothSolver`: 単純だが収束遅い

### 4.3 SIMPLE設定の除去理由
scalarTransportFoamでは圧力-速度カップリングが不要なため、SIMPLE反復は削除。

## 5. 境界条件設定の物理学的考察

### 5.1 流入境界（inlet）
```cpp
type            fixedValue;
value           uniform 0;
```
**物理的意味**: 清浄空気の流入（バックグラウンド濃度ゼロ）

### 5.2 流出境界（outlet）
```cpp
type            zeroGradient;
```
**数学的解釈**: ∂C/∂n = 0（自然流出）
**物理的意味**: 拡散による濃度勾配の自然発達

### 5.3 壁面境界（ground, debris）
```cpp
type            zeroGradient;
```
**境界層理論**: 不透過壁での flux = 0 条件
**代替**: 壁面吸着を考慮する場合は `fixedValue uniform 0`

## 6. 源項定義の数学的モデリング

### 6.1 基本的な源項形式
```cpp
sources
{
    C           (Sp Su);    // Sp*C + Su = net source
}
```

**線形化の利点**:
- **収束性**: 陰的扱いによる数値安定性
- **物理性**: 1次反応（Sp<0）、定数源（Su>0）の自然な表現

### 6.2 時間依存源項のモデリング
```cpp
codeAddSup
#{
    scalar timeFactor = exp(-t/τ);  // 指数減衰
    eqn[celli] += V[celli] * S₀ * timeFactor;
#};
```

**時定数τの物理的意味**:
- 匂い物質の蒸発・分解特性時間
- 実験的決定が必要

## 7. 数値解の検証方法

### 7.1 質量保存の確認
```bash
# 総質量変化率の計算
foamCalc div phi -time '0.5:5'
# 源項積分値との比較検証
```

### 7.2 拡散前線の理論解析
1次元拡散の解析解と比較:
```
C(x,t) = (S₀/√(4πDt)) * exp(-x²/(4Dt))
```

### 7.3 Péclet数による支配機構判定
```
Pe = UL/D
```
- Pe >> 1: 対流支配
- Pe << 1: 拡散支配
- Pe ≈ 1: 両者競合

## 8. トラブルシューティング

### 8.1 数値発散の対処
1. **時間刻み減少**: Courant条件の厳格化
2. **拡散係数調整**: 数値拡散との釣り合い
3. **境界条件見直し**: 非物理的勾配の排除

### 8.2 非現実的濃度分布
1. **源項強度**: 物理的妥当性の確認
2. **拡散係数**: 文献値との比較
3. **メッシュ解像度**: 境界層の適切な解像

### 8.3 計算効率の改善
1. **ソルバー最適化**: 条件数に応じたソルバー選択
2. **前処理行列**: 問題特性に応じた前処理
3. **並列化効率**: ドメイン分解の最適化

## 9. 実用的な設定例

### 9.1 災害現場の匂い拡散
- **拡散係数**: D = 1e-5 m²/s（大気中の有機物）
- **源項強度**: 0.1-10 kg/m³/s（発生源の大きさに依存）
- **計算時間**: 数分〜数時間（拡散範囲に依存）

### 9.2 メッシュ要件
- **境界層**: y⁺ < 30（壁関数使用時）
- **源項周辺**: Δx < 0.1×(源の特性長さ)
- **出口距離**: 10×(対象領域サイズ) 以上

## 10. 発展的応用

### 10.1 多成分拡散
複数の匂い成分の同時計算:
```cpp
application     multiComponentTransportFoam;
```

### 10.2 反応項の追加
```cpp
// 光分解反応
reaction
{
    type            scalarSemiImplicitSource;
    sources
    {
        C           (-k_photo*I 0);  // 光強度I依存
    }
}
```

### 10.3 粒子追跡との連携
```cpp
// Lagrangian粒子による匂い源のモデル化
application     DPMFoam;
```

## 結論

OpenFOAMの2段階ワークフローにおける匂い拡散計算は、適切な設定ファイル修正により、計算効率と物理的妥当性を両立できる強力な手法です。特に、流れ場の固定化、数値スキームの最適化、源項モデリングの3つの要素が成功の鍵となります。

実際の適用においては、対象とする物理現象の特性時間、空間スケール、支配方程式を十分に理解した上で、数値設定を行うことが重要です。