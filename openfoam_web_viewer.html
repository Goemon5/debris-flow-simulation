<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenFOAM 匂い拡散シミュレーション結果</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .status-item {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
        }

        .status-item.success { background: #27ae60; }
        .status-item.running { background: #f39c12; }
        .status-item.pending { background: #95a5a6; }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .plot-container {
            height: 500px;
            margin: 20px 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .control-button.active {
            background: #e74c3c;
        }

        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .parameter-table th,
        .parameter-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .parameter-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        .data-upload {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .data-upload:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .data-upload input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <h1>🌬️ OpenFOAM 匂い拡散シミュレーション</h1>
            <p>瓦礫環境における匂い物質の拡散解析結果</p>
            
            <div class="status">
                <div class="status-item success" id="mesh-status">メッシュ生成: 完了</div>
                <div class="status-item success" id="flow-status">流体解析: 完了</div>
                <div class="status-item running" id="scalar-status">スカラー輸送: 実行中</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text">進捗: 0% (時刻 1001/1005)</div>
        </div>

        <!-- メインコンテンツ -->
        <div class="content-grid">
            <!-- パラメータ表示 -->
            <div class="card">
                <h2>📊 シミュレーション設定</h2>
                <table class="parameter-table">
                    <tr><th>項目</th><th>値</th></tr>
                    <tr><td>匂い源位置</td><td>(2, -3, 0.5) m</td></tr>
                    <tr><td>匂い源半径</td><td>0.3 m</td></tr>
                    <tr><td>風速</td><td>1.0 m/s (X方向)</td></tr>
                    <tr><td>計算領域</td><td>30×35×10 m</td></tr>
                    <tr><td>メッシュセル数</td><td>637,147 cells</td></tr>
                    <tr><td>時間刻み</td><td>0.1 s</td></tr>
                    <tr><td>総時間</td><td>0.4 s (4ステップ)</td></tr>
                </table>
            </div>

            <!-- データアップロード -->
            <div class="card">
                <h2>📁 結果データ読み込み</h2>
                <div class="data-upload" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" multiple accept=".txt,.csv,.dat" onchange="handleFileUpload(event)">
                    <p>📤 OpenFOAMの結果ファイルをドラッグ&ドロップ<br>またはクリックして選択</p>
                    <small>対応形式: .txt, .csv, .dat</small>
                </div>
            </div>
        </div>

        <!-- 可視化エリア -->
        <div class="card full-width">
            <h2>🎨 3D可視化</h2>
            
            <div class="controls">
                <button class="control-button active" onclick="show3DView()">3D濃度分布</button>
                <button class="control-button" onclick="showXYSlice()">XY断面</button>
                <button class="control-button" onclick="showXZSlice()">XZ断面</button>
                <button class="control-button" onclick="showTimeSeries()">時間発展</button>
                <button class="control-button" onclick="showStreamlines()">流線表示</button>
            </div>

            <div class="plot-container" id="main-plot"></div>
        </div>

        <!-- ログ表示 -->
        <div class="card full-width">
            <h2>📝 実行ログ</h2>
            <div class="log-container" id="log-container">
                <div>OpenFOAM シミュレーション開始...</div>
                <div>blockMesh: メッシュ生成完了 (637,147 cells)</div>
                <div>snappyHexMesh: 瓦礫周辺メッシュ細分化完了</div>
                <div>foamRun: 流体解析実行中...</div>
                <div>時刻 1001: 収束判定 OK</div>
                <div>時刻 1002: 収束判定 OK</div>
                <div>時刻 1003: 収束判定 OK</div>
                <div class="running">時刻 1004: 計算中...</div>
            </div>
        </div>
    </div>

    <script>
        // 進捗バーの更新
        let progress = 75; // 75%完了と仮定
        document.getElementById('progress-fill').style.width = progress + '%';
        document.getElementById('progress-text').textContent = 
            `進捗: ${progress}% (時刻 1004/1005)`;

        // 3D可視化の初期化
        function initializePlot() {
            // サンプルデータで3D濃度分布を作成
            const x = [], y = [], z = [], concentration = [];
            
            // 匂い源周辺のデータ生成
            for (let i = -10; i <= 20; i += 1) {
                for (let j = -15; j <= 10; j += 1) {
                    for (let k = 0; k <= 6; k += 0.5) {
                        const dist = Math.sqrt(Math.pow(i-2, 2) + Math.pow(j+3, 2) + Math.pow(k-0.5, 2));
                        const windEffect = i >= 2 ? Math.exp(-(i-2)/8) : Math.exp(-(2-i)/3) * 0.1;
                        const conc = windEffect * Math.exp(-dist/4) * Math.exp(-Math.pow(j+3, 2)/15);
                        
                        if (conc > 0.01) {
                            x.push(i);
                            y.push(j);
                            z.push(k);
                            concentration.push(conc);
                        }
                    }
                }
            }

            const trace = {
                x: x,
                y: y,
                z: z,
                mode: 'markers',
                marker: {
                    size: concentration.map(c => c * 15 + 2),
                    color: concentration,
                    colorscale: [
                        [0, 'rgb(255,255,255)'],
                        [0.2, 'rgb(255,255,0)'],
                        [0.5, 'rgb(255,165,0)'],
                        [0.8, 'rgb(255,69,0)'],
                        [1, 'rgb(139,0,0)']
                    ],
                    opacity: 0.8,
                    colorbar: {
                        title: "濃度",
                        titleside: "right"
                    }
                },
                type: 'scatter3d',
                name: '匂い濃度'
            };

            // 匂い源
            const source = {
                x: [2],
                y: [-3],
                z: [0.5],
                mode: 'markers',
                marker: {
                    size: 20,
                    color: 'red',
                    symbol: 'diamond'
                },
                type: 'scatter3d',
                name: '匂い源'
            };

            const layout = {
                title: {
                    text: '3D 匂い濃度分布',
                    font: { size: 18 }
                },
                scene: {
                    xaxis: { title: 'X (m)', range: [-15, 15] },
                    yaxis: { title: 'Y (m)', range: [-20, 15] },
                    zaxis: { title: 'Z (m)', range: [-2, 8] },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 0.8 },
                        center: { x: 0, y: 0, z: 0 }
                    },
                    aspectmode: 'cube'
                },
                showlegend: true,
                margin: { l: 0, r: 0, b: 0, t: 40 }
            };

            Plotly.newPlot('main-plot', [trace, source], layout, {responsive: true});
        }

        // 表示切り替え関数
        function show3DView() {
            updateActiveButton(event.target);
            initializePlot();
        }

        function showXYSlice() {
            updateActiveButton(event.target);
            
            const x = [], y = [], z = [];
            for (let i = -15; i <= 15; i += 0.5) {
                const row_y = [], row_z = [];
                for (let j = -20; j <= 15; j += 0.5) {
                    const dist = Math.sqrt(Math.pow(i-2, 2) + Math.pow(j+3, 2));
                    const windEffect = i >= 2 ? Math.exp(-(i-2)/10) : Math.exp(-(2-i)/5) * 0.1;
                    const conc = windEffect * Math.exp(-dist/8) * Math.exp(-Math.pow(j+3, 2)/25);
                    
                    row_y.push(j);
                    row_z.push(conc);
                }
                if (i === -15) y.push(...row_y);
                x.push(i);
                z.push(row_z);
            }

            const trace = {
                x: x,
                y: y[0] !== undefined ? y.slice(0, z[0].length) : [],
                z: z,
                type: 'contour',
                colorscale: 'Hot',
                colorbar: { title: "濃度" },
                contours: {
                    showlines: true,
                    linewidth: 1,
                    linecolor: 'black'
                }
            };

            const source = {
                x: [2],
                y: [-3],
                mode: 'markers',
                marker: { size: 15, color: 'blue', symbol: 'star' },
                type: 'scatter',
                name: '匂い源'
            };

            const layout = {
                title: 'XY平面での匂い分布 (Z=0.5m)',
                xaxis: { title: 'X (m)' },
                yaxis: { title: 'Y (m)' },
                showlegend: true
            };

            Plotly.newPlot('main-plot', [trace, source], layout, {responsive: true});
        }

        function showXZSlice() {
            updateActiveButton(event.target);
            // XZ断面の実装（省略）
        }

        function showTimeSeries() {
            updateActiveButton(event.target);
            // 時間発展の実装（省略）
        }

        function showStreamlines() {
            updateActiveButton(event.target);
            // 流線表示の実装（省略）
        }

        function updateActiveButton(activeBtn) {
            document.querySelectorAll('.control-button').forEach(btn => 
                btn.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        // ファイルアップロード処理
        function handleFileUpload(event) {
            const files = event.target.files;
            const logContainer = document.getElementById('log-container');
            
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    logContainer.innerHTML += `<div>ファイル読み込み完了: ${file.name}</div>`;
                    logContainer.scrollTop = logContainer.scrollHeight;
                    
                    // ここで実際のデータ処理を行う
                    processOpenFOAMData(content, file.name);
                };
                reader.readAsText(file);
            }
        }

        function processOpenFOAMData(content, filename) {
            // OpenFOAMデータの解析処理（実装省略）
            console.log(`Processing ${filename}:`, content.substring(0, 200));
        }

        // 自動更新（実際のシミュレーションでは定期的にデータを更新）
        function simulateProgress() {
            setTimeout(() => {
                if (progress < 100) {
                    progress += 5;
                    document.getElementById('progress-fill').style.width = progress + '%';
                    document.getElementById('progress-text').textContent = 
                        `進捗: ${progress}% (時刻 ${Math.min(1001 + Math.floor(progress/25), 1005)}/1005)`;
                    
                    if (progress >= 100) {
                        document.getElementById('scalar-status').textContent = 'スカラー輸送: 完了';
                        document.getElementById('scalar-status').className = 'status-item success';
                        
                        const logContainer = document.getElementById('log-container');
                        logContainer.innerHTML += '<div class="success">シミュレーション完了！</div>';
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                    
                    simulateProgress();
                }
            }, 2000);
        }

        // ページ読み込み時の初期化
        window.onload = function() {
            initializePlot();
            simulateProgress();
        };
    </script>
</body>
</html>